<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h2>ì±„íŒ…ë°©</h2>
    <p><strong>ì„¸ì…˜ ID:</strong> <span id="session-id"></span></p>
    <textarea id="message-box" rows="4" cols="50" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea><br>
    <button onclick="sendMessage()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
    <h3>ë°›ì€ ë©”ì‹œì§€</h3>
    <ul id="messages"></ul>

    <script>
        const sessionId = Math.random().toString(36).substring(7); // ì„¸ì…˜ êµ¬ë¶„ìš© ëœë¤ ID
        document.getElementById("session-id").innerText = sessionId;

        // ì›¹ì†Œì¼“ ì—°ê²°
        const socket = new SockJS("http://localhost:8080/ws-stomp"); // ì„œë²„ ì£¼ì†Œ
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("âœ… ì—°ê²° ì„±ê³µ: " + frame);

            // session ID êµ¬ë…
            stompClient.subscribe("/sub/session-id", function (message){
                console.log("ì„¸ì…˜ ID : ", message.body);
            });
            
            console.log("123");
            if (frame.headers.session) {
                console.log("ğŸŸ ì„œë²„ì—ì„œ ë°›ì€ ì„¸ì…˜ ID: ", frame.headers.session);
            }

            console.log("123");

            // session ID ë°œí–‰
            

            // íŠ¹ì • ì±„íŒ…ë°© êµ¬ë…
            stompClient.subscribe("/sub/channel/100", function (message) {
                console.log("ğŸ“© ë°›ì€ ë©”ì‹œì§€: ", message.body);
                const msgList = document.getElementById("messages");
                const newMsg = document.createElement("li");
                newMsg.textContent = message.body;
                msgList.appendChild(newMsg);
            });
        }, function (error) {
            console.error("âŒ ì—°ê²° ì‹¤íŒ¨: ", error);
        });

        // ë©”ì‹œì§€ ë³´ë‚´ê¸° í•¨ìˆ˜
        function sendMessage() {
            const messageContent = document.getElementById("message-box").value;
            if (messageContent.trim() !== "") {
                stompClient.send("/pub/channel", {}, JSON.stringify({
                    userId: sessionId, 
                    groupId: "100", 
                    content: messageContent
                }));
                document.getElementById("message-box").value = "";
            }
        }

        // í˜ì´ì§€ ë‹«ì„ ë•Œ ì—°ê²° í•´ì œ
        window.addEventListener("beforeunload", function () {
            stompClient.disconnect(function () {
                console.log("ğŸ”Œ ì—°ê²° ì¢…ë£Œ");
            });
        });
    </script>
</body>
</html>